# New Onboarding Flow Implementation Plan

## User Flow
```
Therapist Homepage
  ↓ "Get Started" button
Quick Start Flow (6 screens, anonymous, localStorage)
  ↓ Complete all screens
Welcome Screen: "Welcome to Mindfolk, [FirstName]!"
  ↓ "Create Account" button
Sign-up Page/Modal
  - Pre-filled: firstName, lastName
  - Ask for: email, password, professionalTitle, registrationBody, licenseNumber
  ↓ Submit
Create Auth User + Therapist Profile
  ↓ Save Quick Start data to database
Redirect to Dashboard
  ↓
Contextual Onboarding (email verification as background task)
```

## Implementation Steps

### 1. Make Quick Start Accessible Without Authentication
**File**: `src/App.tsx`
- Ensure `/t/quick-start` route doesn't require authentication
- Remove any auth guards from the Quick Start route

**File**: `src/pages/therapist/QuickStart.tsx`
- Remove supabase.auth checks at component mount
- Allow anonymous access to all 6 screens

### 2. Store Quick Start Data in localStorage
**File**: `src/pages/therapist/QuickStart.tsx`

**Add localStorage persistence:**
```typescript
// Save to localStorage after each step
useEffect(() => {
  if (formData.firstName || formData.email) {
    localStorage.setItem('quickStartProgress', JSON.stringify({
      ...formData,
      currentStep,
      completedAt: new Date().toISOString()
    }));
  }
}, [formData, currentStep]);

// Load from localStorage on mount
useEffect(() => {
  const savedProgress = localStorage.getItem('quickStartProgress');
  if (savedProgress) {
    const parsed = JSON.parse(savedProgress);
    setFormData(parsed);
    setCurrentStep(parsed.currentStep || 1);
  }
}, []);
```

### 3. Update Welcome Screen to Show Sign-up CTA
**File**: `src/pages/therapist/QuickStart.tsx` (Welcome screen - step 6)

**Replace navigation button with sign-up CTA:**
```typescript
// Instead of "Go to Dashboard" button:
<Button
  size="lg"
  onClick={handleCreateAccount}
  className="w-full"
>
  Create Your Account to Build Your Workspace
</Button>
```

**Add handler:**
```typescript
const handleCreateAccount = () => {
  // Save current state to localStorage
  localStorage.setItem('quickStartComplete', 'true');

  // Navigate to sign-up page
  navigate('/signup');
};
```

### 4. Create/Update Sign-up Page
**File**: `src/pages/therapist/Signup.tsx` (or create if doesn't exist)

**Pre-fill from localStorage:**
```typescript
const Signup = () => {
  const navigate = useNavigate();
  const quickStartData = JSON.parse(localStorage.getItem('quickStartProgress') || '{}');

  const [formData, setFormData] = useState({
    email: quickStartData.email || '',
    password: '',
    confirmPassword: '',
    // Already have from Quick Start:
    firstName: quickStartData.firstName,
    lastName: quickStartData.lastName,
    professionalTitle: quickStartData.title,
    registrationBody: quickStartData.registrationBody,
    licenseNumber: quickStartData.licenseNumber,
  });

  const handleSignup = async (e) => {
    e.preventDefault();

    // 1. Create auth user
    const { data: authData, error: authError } = await supabase.auth.signUp({
      email: formData.email,
      password: formData.password,
      options: {
        emailRedirectTo: `${window.location.origin}/auth/callback`,
        data: {
          first_name: formData.firstName,
          last_name: formData.lastName,
        }
      }
    });

    if (authError) {
      // Handle error
      return;
    }

    // 2. Create therapist profile with Quick Start data
    const { error: profileError } = await supabase
      .from('therapist_profiles')
      .insert({
        id: authData.user.id,
        first_name: formData.firstName,
        last_name: formData.lastName,
        email: formData.email,
        title: formData.professionalTitle,
        registration_body: formData.registrationBody,
        license_number: formData.licenseNumber,
        communication_style: quickStartData.communicationStyle,
        session_format: quickStartData.sessionFormat,
        specialties: quickStartData.specialties,
        modalities: quickStartData.modalities,
        years_experience: quickStartData.yearsExperience,
        // personality_tags will be auto-generated by database trigger
      });

    if (profileError) {
      // Handle error
      return;
    }

    // 3. Clear localStorage
    localStorage.removeItem('quickStartProgress');
    localStorage.removeItem('quickStartComplete');

    // 4. Redirect to dashboard
    navigate('/t/dashboard');
  };

  return (
    // Sign-up form UI
  );
};
```

### 5. Update Dashboard to Show Contextual Onboarding
**File**: `src/pages/therapist/Dashboard.tsx`

**Add email verification as setup task:**
```typescript
const setupTasks = [
  {
    id: 'quick-start',
    label: 'Complete Quick Start',
    completed: true, // Always true since they just did it
  },
  {
    id: 'verify-email',
    label: 'Verify your email',
    completed: user?.email_confirmed_at != null,
    action: () => {
      // Send verification email or show instructions
    },
  },
  {
    id: 'set-availability',
    label: 'Set your availability',
    completed: hasAvailability,
  },
  {
    id: 'set-rates',
    label: 'Set your session rates',
    completed: hasRates,
  },
  {
    id: 'upload-photo',
    label: 'Upload profile photo',
    completed: hasPhoto,
  },
  {
    id: 'record-video',
    label: 'Record introduction video',
    completed: hasVideo,
  },
];
```

**Show email verification banner if not verified:**
```typescript
{!user?.email_confirmed_at && (
  <Alert>
    <AlertCircle className="h-4 w-4" />
    <AlertTitle>Verify your email</AlertTitle>
    <AlertDescription>
      Check your inbox for a verification link to start receiving client matches.
      <Button variant="link" onClick={resendVerificationEmail}>
        Resend email
      </Button>
    </AlertDescription>
  </Alert>
)}
```

### 6. Update Profile Publishing Gate
**File**: `src/pages/therapist/Profile.tsx` (or wherever publish button lives)

**Block publishing if email not verified:**
```typescript
const canPublish =
  profileComplete &&
  user?.email_confirmed_at != null;

<Button
  disabled={!canPublish}
  onClick={publishProfile}
>
  {!user?.email_confirmed_at
    ? 'Verify Email to Publish Profile'
    : 'Publish Profile'
  }
</Button>
```

### 7. Update Homepage CTA
**File**: `src/pages/LandingPage.tsx` or therapist homepage

**"Get Started" button routes to Quick Start:**
```typescript
<Button onClick={() => navigate('/t/quick-start')}>
  Get Started
</Button>
```

## Files to Create/Modify

**Create:**
- `src/pages/therapist/Signup.tsx` (or update existing)
- `docs/ONBOARDING_FLOW_IMPLEMENTATION.md` (this file)

**Modify:**
- `src/App.tsx` (routing)
- `src/pages/therapist/QuickStart.tsx` (localStorage, navigation)
- `src/pages/therapist/Dashboard.tsx` (contextual onboarding)
- `src/pages/therapist/Profile.tsx` (publish gate)
- Homepage component (CTA button)

## Data Flow

```
localStorage (anonymous):
{
  firstName: "Sarah",
  lastName: "Chen",
  email: "sarah@example.com",
  title: "Clinical Psychologist",
  registrationBody: "BACP",
  licenseNumber: "12345",
  communicationStyle: "Supportive & Relational (...)",
  sessionFormat: "Flexible & Adaptive (...)",
  specialties: ["Trauma", "Anxiety", "Depression"],
  modalities: ["CBT", "EMDR"],
  yearsExperience: "5-10 years",
  currentStep: 6,
  completedAt: "2025-10-02T12:00:00.000Z"
}
  ↓ (after sign-up)
Database (authenticated):
therapist_profiles {
  id: [auth_user_id],
  first_name: "Sarah",
  last_name: "Chen",
  email: "sarah@example.com",
  title: "Clinical Psychologist",
  registration_body: "BACP",
  license_number: "12345",
  communication_style: "Supportive & Relational (...)",
  session_format: "Flexible & Adaptive (...)",
  specialties: ["Trauma", "Anxiety", "Depression"],
  modalities: ["CBT", "EMDR"],
  years_experience: "5-10 years",
  personality_tags: ["supportive", "empathetic", "warm", "flexible", "adaptive"], // auto-generated by trigger
  created_at: [timestamp],
  updated_at: [timestamp]
}
```

## Benefits

1. **Zero friction start** - No sign-up wall
2. **Value demonstration** - Therapists complete full Quick Start before committing
3. **Investment bias** - More likely to complete sign-up after 6 screens
4. **No email verification blocker** - Can explore dashboard immediately
5. **Logical profile publish gate** - Email verification required for client contact
6. **Existing infrastructure** - Uses contextual onboarding already built

## Next Steps

1. Implement localStorage persistence in QuickStart.tsx
2. Create/update Signup page with pre-fill logic
3. Update routing to remove auth guards from Quick Start
4. Update Dashboard contextual onboarding
5. Add profile publishing gate
6. Test full flow end-to-end

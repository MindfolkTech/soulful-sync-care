# Phase 1: Database Schema Baseline Report
**Generated:** 2025-09-29
**Project:** Mindfolk (soulful-sync-care)
**Project ID:** curxanzghxehsjyoyukj
**Purpose:** Ground truth schema reference for 6-agent type audit coordination

---

## A. Schema Generation Status

‚úÖ **Fresh types generated from live Supabase schema**
‚úÖ **Types match existing database.types.ts**
üìä **Drift detected:** NONE - Files are in perfect sync
üïê **Last regeneration:** 2025-09-29 (during this Phase 1 execution)
‚úÖ **PostgrestVersion:** 13.0.5

### Type File Location
- **Root level:** `C:\Users\carol\Desktop\Mindfolk Cursor\soulful-sync-care\database.types.ts`
- **Status:** Current and accurate as of 2025-09-29

---

## B. Table Inventory (21 Tables by Domain)

### 1. CORE USER DOMAIN

#### profiles (64 rows, 4 RLS policies)
**Purpose:** Base user profiles for all platform users
**Columns:**
- `id`: uuid (PK, NOT NULL) - Foreign key to auth.users
- `email`: text (NOT NULL)
- `first_name`: text (nullable)
- `last_name`: text (nullable)
- `role`: app_role (NOT NULL, default: 'client') - **ENUM: client | therapist | admin**
- `phone`: text (nullable)
- `created_at`: timestamptz (NOT NULL, default: now())
- `updated_at`: timestamptz (NOT NULL, default: now())

**Indexes:**
- PRIMARY KEY: `profiles_pkey` (id)
- `idx_profiles_role` (role) - For role-based queries

**RLS Policies:** 4 policies enabled

---

### 2. THERAPIST DOMAIN

#### therapist_profiles (12 rows, 4 RLS policies) ‚ö†Ô∏è CRITICAL FOR MATCHING
**Purpose:** Complete therapist profile data including personality tags
**Key Array Columns (GIN Indexed):**
- `specialties`: text[] (default: '{}') - **24 available options** - GIN indexed
- `modalities`: text[] (default: '{}') - **10 available options** - GIN indexed
- `personality_tags`: text[] (default: '{}') - **Auto-generated by algorithm** - GIN indexed
- `identity_tags`: text[] (default: '{}') - **4 available options** - GIN indexed
- `languages`: text[] (default: '{}') - **50+ languages available** - GIN indexed
- `cultural_background`: text[] (default: '{}')

**Key Enum-Like Text Columns:**
- `communication_style`: text (nullable) - Values from `communication_style_enum`
- `session_format`: text (nullable) - Values from `session_format_enum`
- `years_experience`: text (nullable) - CHECK constraint: 'Less than 2 years' | 'More than 2 years' | 'More than 5 years' | 'More than 10 years'

**Key JSON/JSONB Columns:**
- `session_rates`: jsonb (NOT NULL, default: '{}')
- `availability`: jsonb (NOT NULL, default: '{}')
- `availability_hours`: jsonb (nullable, default: '{}') - Weekly schedule
- `setup_steps`: jsonb (NOT NULL, default: '{}') - Onboarding progress
- `onboarding_state`: jsonb (nullable) - Contextual onboarding tracking with structure:
  ```typescript
  {
    current_step: string | null,
    skipped_steps: string[],
    completed_steps: string[],
    last_step_completed_at: timestamp | null,
    contextual_onboarding_started: boolean,
    profile_completion_milestones: {
      "40_percent": timestamp | null,
      "60_percent": timestamp | null,
      "80_percent": timestamp | null,
      "100_percent": timestamp | null
    },
    contextual_onboarding_completed: boolean
  }
  ```
- `feature_flags`: jsonb (nullable, default: '{}')

**Key Scalar Columns:**
- `user_id`: uuid (NOT NULL, unique) - FK to profiles
- `application_id`: uuid (nullable) - FK to therapist_applications
- `name`: text (NOT NULL)
- `tagline`: text (nullable)
- `bio`: text (nullable)
- `quote`: text (nullable) - Max 60 chars recommended
- `avatar_url`: text (nullable)
- `video_url`: text (nullable)
- `license_number`: text (NOT NULL)
- `location_city`: text (nullable)
- `location_state`: text (nullable)
- `location_country`: text (nullable, default: 'US')
- `timezone`: text (nullable)
- `gender_identity`: text (nullable) - For same-gender matching
- `age_group`: text (nullable) - For similar-age matching
- `cancellation_policy`: text (nullable)
- `rescheduling_policy`: text (nullable)
- `lateness_policy`: text (nullable)
- `communication_policy`: text (nullable)
- `cancellation_notice`: text (nullable)
- `auto_accept_hours`: integer (nullable) - NULL = manual approval only
- `profile_strength`: integer (nullable, default: 0) - CHECK: 0-100
- `insurance_confirmed`: boolean (nullable, default: false)
- `id_document_url`: text (nullable)
- `accepts_new_clients`: boolean (NOT NULL, default: true)
- `online_sessions`: boolean (NOT NULL, default: true)
- `in_person_sessions`: boolean (NOT NULL, default: false)
- `verified`: boolean (NOT NULL, default: false)
- `is_active`: boolean (NOT NULL, default: true)
- `setup_completed`: boolean (NOT NULL, default: false)
- `verification_date`: timestamptz (nullable)
- `created_at`: timestamptz (NOT NULL, default: now())
- `updated_at`: timestamptz (NOT NULL, default: now())

**Indexes (10 total):**
- PRIMARY KEY: `therapist_profiles_pkey` (id)
- UNIQUE: `therapist_profiles_user_id_key` (user_id)
- GIN: `idx_therapist_profiles_specialties_gin` (specialties) ‚ö†Ô∏è CRITICAL
- GIN: `idx_therapist_profiles_modalities_gin` (modalities) ‚ö†Ô∏è CRITICAL
- GIN: `idx_therapist_profiles_personality_tags_gin` (personality_tags) ‚ö†Ô∏è CRITICAL
- GIN: `idx_therapist_profiles_identity_tags_gin` (identity_tags) ‚ö†Ô∏è CRITICAL
- GIN: `idx_therapist_profiles_languages` (languages)
- GIN: `idx_therapist_profiles_onboarding_state_gin` (onboarding_state)
- B-tree: `idx_therapist_profiles_user_id` (user_id)
- Composite: `idx_therapist_profiles_active_verified` (is_active, verified, accepts_new_clients) WHERE is_active=true AND verified=true

**Views:**
- `therapist_profiles_public` - Public-facing data
- `therapist_profiles_internal` - Admin-only data

---

#### therapist_applications (1 row, 4 RLS policies)
**Purpose:** Therapist application and verification tracking
**Key Columns:**
- `id`: uuid (PK)
- `user_id`: uuid (NOT NULL, unique)
- `name`: text (NOT NULL)
- `email`: text (NOT NULL)
- `license_number`: text (NOT NULL)
- `specialties`: text[] (default: '{}')
- `experience`: text (NOT NULL)
- `documents`: jsonb (default: '{}')
- `status`: application_status (default: 'pending') - **ENUM: pending | under_review | approved | rejected**
- `background_check`: boolean (default: false)
- `registration_body`: text (nullable)
- `license_jurisdiction`: text (nullable)
- `license_expiry`: date (nullable)
- `insurance_provider`: text (nullable)
- `insurance_expiry`: date (nullable)
- `public_register_url`: text (nullable)
- `reviewed_by`: uuid (nullable)
- `reviewed_at`: timestamptz (nullable)
- `decision_reason`: text (nullable)
- `submitted_at`: timestamptz (NOT NULL, default: now())
- `created_at`: timestamptz (NOT NULL, default: now())
- `updated_at`: timestamptz (NOT NULL, default: now())

**Indexes:**
- PRIMARY KEY: `therapist_applications_pkey` (id)
- UNIQUE: `therapist_applications_user_id_key` (user_id)
- Composite: `idx_therapist_applications_status_submitted_at` (status, submitted_at DESC)
- B-tree: `idx_therapist_applications_user_id` (user_id)

---

#### therapist_availability (0 rows, 2 RLS policies)
**Purpose:** Weekly recurring availability slots
**Columns:**
- `id`: uuid (PK)
- `therapist_id`: uuid (NOT NULL) - FK to therapist_profiles.user_id
- `day_of_week`: integer (NOT NULL) - CHECK: 0-6 (0=Sunday)
- `start_time`: time (NOT NULL)
- `end_time`: time (NOT NULL)
- `is_available`: boolean (default: true)
- `recurring`: boolean (default: true)
- `created_at`: timestamptz (default: now())
- `updated_at`: timestamptz (default: now())

**Indexes:**
- PRIMARY KEY: `therapist_availability_pkey` (id)
- RLS: `idx_therapist_availability_therapist_id_rls` (therapist_id) WHERE therapist_id IS NOT NULL

---

#### therapist_blocked_times (0 rows, 2 RLS policies)
**Purpose:** Vacation, holidays, unavailable periods
**Columns:**
- `id`: uuid (PK)
- `therapist_id`: uuid (NOT NULL) - FK to therapist_profiles.user_id
- `title`: text (NOT NULL)
- `start_date`: date (NOT NULL)
- `end_date`: date (NOT NULL)
- `start_time`: time (nullable)
- `end_time`: time (nullable)
- `all_day`: boolean (default: false)
- `recurring`: boolean (default: false)
- `notes`: text (nullable)
- `created_at`: timestamptz (default: now())
- `updated_at`: timestamptz (default: now())

**Indexes:**
- PRIMARY KEY: `therapist_blocked_times_pkey` (id)
- RLS: `idx_therapist_blocked_times_therapist_id_rls` (therapist_id) WHERE therapist_id IS NOT NULL

---

#### therapist_analytics (0 rows, 2 RLS policies)
**Purpose:** Daily performance metrics
**Columns:**
- `id`: uuid (PK)
- `therapist_id`: uuid (NOT NULL) - FK to therapist_profiles.user_id
- `metric_date`: date (NOT NULL)
- `total_sessions`: integer (default: 0)
- `completed_sessions`: integer (default: 0)
- `cancelled_sessions`: integer (default: 0)
- `no_show_sessions`: integer (default: 0)
- `total_earnings`: numeric (default: 0)
- `average_session_rating`: numeric (nullable)
- `new_clients`: integer (default: 0)
- `returning_clients`: integer (default: 0)
- `created_at`: timestamptz (default: now())
- `updated_at`: timestamptz (default: now())

**Indexes:**
- PRIMARY KEY: `therapist_analytics_pkey` (id)
- UNIQUE: `therapist_analytics_therapist_id_metric_date_key` (therapist_id, metric_date)

---

### 3. CLIENT DOMAIN

#### client_assessments (51 rows, 3 RLS policies) ‚ö†Ô∏è CRITICAL FOR MATCHING
**Purpose:** Client preferences and needs for matching algorithm
**Key Array Columns:**
- `therapy_modalities`: text[] (default: '{}') - **GIN indexed for matching**
- `communication_preferences`: text[] (default: '{}')
- `language_preferences`: text[] (default: '{}')
- `identity_preferences`: text[] (default: '{}')
- `therapy_goals`: text[] (default: '{}')
- `preferred_times`: text[] (default: '{}')
- `budget_range`: integer[] (default: '{0,0}') - [min, max] price range

**Matching Preference Columns:**
- `prefers_similar_age`: boolean (default: false)
- `prefers_same_gender`: boolean (default: false)
- `prefers_cultural_background_match`: boolean (default: false)
- `experience_preference`: text (nullable) - 'No preference' | 'More than 2 years' | 'More than 5 years' | 'More than 10 years'

**Client Identity Columns:**
- `age_group`: text (nullable) - For similar-age matching
- `gender_identity`: text (nullable) - For same-gender matching
- `cultural_identity`: text (nullable) - For cultural matching

**Other Columns:**
- `id`: uuid (PK)
- `user_id`: uuid (NOT NULL)
- `previous_therapy`: boolean (default: false)
- `crisis_support`: boolean (default: false)
- `created_at`: timestamptz (default: now())
- `updated_at`: timestamptz (default: now())

**Indexes:**
- PRIMARY KEY: `client_assessments_pkey` (id)
- GIN: `idx_client_assessments_specialties_gin` (therapy_modalities) ‚ö†Ô∏è CRITICAL
- RLS: `idx_client_assessments_user_id_rls` (user_id) WHERE user_id IS NOT NULL

---

#### client_session_notes (0 rows, 2 RLS policies)
**Purpose:** Therapist notes for client sessions
**Columns:**
- `id`: uuid (PK)
- `appointment_id`: uuid (NOT NULL) - FK to appointments
- `therapist_id`: uuid (NOT NULL) - FK to therapist_profiles.user_id
- `client_id`: uuid (NOT NULL) - FK to auth.users
- `session_notes`: text (nullable)
- `client_progress`: text (nullable)
- `next_session_goals`: text (nullable)
- `mood_rating`: integer (nullable) - CHECK: 1-10
- `session_rating`: integer (nullable) - CHECK: 1-5
- `private_notes`: text (nullable)
- `created_at`: timestamptz (default: now())
- `updated_at`: timestamptz (default: now())

**Indexes:**
- PRIMARY KEY: `client_session_notes_pkey` (id)
- RLS: `idx_client_session_notes_therapist_id_rls` (therapist_id) WHERE therapist_id IS NOT NULL
- RLS: `idx_client_session_notes_client_id_rls` (client_id) WHERE client_id IS NOT NULL

---

#### client_testimonials (0 rows, 3 RLS policies)
**Purpose:** Client reviews for therapists
**Columns:**
- `id`: uuid (PK)
- `therapist_id`: uuid (NOT NULL)
- `client_id`: uuid (NOT NULL)
- `appointment_id`: uuid (nullable) - FK to appointments
- `rating`: integer (nullable) - CHECK: 1-5
- `testimonial_text`: text (nullable)
- `is_public`: boolean (default: false)
- `created_at`: timestamptz (default: now())
- `updated_at`: timestamptz (default: now())

**Indexes:**
- PRIMARY KEY: `client_testimonials_pkey` (id)
- RLS: `idx_client_testimonials_therapist_id_rls` (therapist_id) WHERE therapist_id IS NOT NULL
- RLS: `idx_client_testimonials_client_id_rls` (client_id) WHERE client_id IS NOT NULL

---

### 4. APPOINTMENT DOMAIN

#### appointments (0 rows, 4 RLS policies)
**Purpose:** Scheduled therapy sessions
**Columns:**
- `id`: uuid (PK)
- `therapist_id`: uuid (NOT NULL) - FK to therapist_profiles.user_id
- `client_id`: uuid (NOT NULL) - FK to auth.users
- `session_type`: text (default: 'therapy_session')
- `session_date`: date (NOT NULL)
- `session_time`: time (NOT NULL)
- `duration_minutes`: integer (default: 60)
- `status`: text (default: 'scheduled') - CHECK: 'scheduled' | 'confirmed' | 'in_progress' | 'completed' | 'cancelled' | 'no_show'
- `session_rate`: numeric (nullable)
- `notes`: text (nullable)
- `created_at`: timestamptz (default: now())
- `updated_at`: timestamptz (default: now())

**Indexes:**
- PRIMARY KEY: `appointments_pkey` (id)
- UNIQUE: `appointments_therapist_id_session_date_session_time_key` (therapist_id, session_date, session_time)
- B-tree: `idx_appointments_therapist_id` (therapist_id)
- B-tree: `idx_appointments_client_id` (client_id)
- RLS: `idx_appointments_therapist_id_rls` (therapist_id) WHERE therapist_id IS NOT NULL
- RLS: `idx_appointments_client_id_rls` (client_id) WHERE client_id IS NOT NULL
- Composite: `idx_appointments_therapist_date` (therapist_id, session_date)
- Composite: `idx_appointments_date_status` (session_date, status)

---

#### session_earnings (0 rows, 2 RLS policies)
**Purpose:** Financial records per session
**Columns:**
- `id`: uuid (PK)
- `appointment_id`: uuid (NOT NULL) - FK to appointments
- `therapist_id`: uuid (NOT NULL) - FK to therapist_profiles.user_id
- `gross_amount`: numeric (NOT NULL)
- `platform_fee`: numeric (default: 0)
- `net_amount`: numeric (NOT NULL)
- `payout_status`: text (default: 'pending') - CHECK: 'pending' | 'processing' | 'paid' | 'failed'
- `payout_date`: date (nullable)
- `created_at`: timestamptz (default: now())
- `updated_at`: timestamptz (default: now())

**Indexes:**
- PRIMARY KEY: `session_earnings_pkey` (id)
- RLS: `idx_session_earnings_therapist_id_rls` (therapist_id) WHERE therapist_id IS NOT NULL

---

### 5. REFERENCE TABLES (Controlled Vocabulary)

#### specialities (24 rows, 1 RLS policy)
**Purpose:** Standard specialty options for therapists
**Available Values:**
1. Anger management
2. Anxiety
3. Autism
4. Bipolar disorder
5. Bullying
6. Career difficulties
7. Chronic illness
8. Concentration, memory and focus (ADHD)
9. Coping with addictions
10. Depression
11. Eating disorders
12. Executive and Professional coaching
13. Family conflict
14. Grief and loss
15. LGBT-related issues
16. Motivation and self-esteem
17. OCD
18. Parenting issues
19. Phobias
20. PTSD
21. Race and racial identity
22. Relationship and intimacy issues
23. Tourettes syndrome
24. Trauma and abuse

**Columns:**
- `id`: uuid (PK)
- `name`: text (NOT NULL, unique)
- `description`: text (nullable)
- `created_at`: timestamptz (default: now())
- `updated_at`: timestamptz (default: now())

---

#### modalities (10 rows, 1 RLS policy)
**Purpose:** Standard therapy modality options
**Available Values:**
1. Cognitive Behavioural Therapy (CBT)
2. Compassion Focused Therapy (CFT)
3. EMDR Therapy
4. Family systems therapy
5. Integrative/eclectic approach
6. Interpersonal Therapy
7. Mindfulness-based Therapy (MBCT)
8. Person-centered Therapy
9. Psychodynamic therapy
10. Trauma-focused therapy

**Columns:**
- `id`: uuid (PK)
- `name`: text (NOT NULL, unique)
- `description`: text (nullable)
- `created_at`: timestamptz (default: now())
- `updated_at`: timestamptz (default: now())

---

#### identity_tags (4 rows, 2 RLS policies)
**Purpose:** Standard identity tag options for inclusive matching
**Available Values:**
1. Culturally sensitive and aware
2. LGBTQ+ friendly and affirming
3. Neurodiversity affirming
4. Trauma-informed and gentle

**Columns:**
- `id`: uuid (PK)
- `name`: text (NOT NULL, unique)
- `description`: text (nullable)
- `created_at`: timestamptz (default: now())

---

#### languages (50 rows, 1 RLS policy)
**Purpose:** Available therapy languages
**Columns:**
- `id`: uuid (PK)
- `name`: text (NOT NULL, unique)
- `iso_code`: text (nullable)
- `created_at`: timestamptz (default: now())
- `updated_at`: timestamptz (default: now())

---

#### professional_bodies (17 rows, 1 RLS policy)
**Purpose:** UK accreditation organizations
**Available Abbreviations:**
ACC, AHPP, BAAT, BABCP, BACP, BADth, BAMT, BAPT, BPS, COSCA, FPC, HCPC, HCPC_ARTS, IPTUK, NCS, UKAHPP, UKCP

**Columns:**
- `id`: uuid (PK)
- `name`: text (NOT NULL)
- `abbreviation`: text (nullable)
- `region`: text (default: 'UK')
- `created_at`: timestamptz (default: now())
- `updated_at`: timestamptz (default: now())

---

### 6. PLATFORM FEATURES

#### favorites (0 rows, 3 RLS policies)
**Purpose:** Client saved therapists
**Columns:**
- `id`: uuid (PK)
- `user_id`: uuid (NOT NULL) - FK to auth.users
- `therapist_id`: uuid (NOT NULL) - FK to therapist_profiles.user_id
- `created_at`: timestamptz (default: now())

**Indexes:**
- PRIMARY KEY: `favorites_pkey` (id)
- UNIQUE: `favorites_user_id_therapist_id_key` (user_id, therapist_id)
- B-tree: `idx_favorites_user_id` (user_id)
- B-tree: `idx_favorites_therapist_id` (therapist_id)

---

#### notifications (0 rows, 3 RLS policies)
**Purpose:** User notifications system
**Columns:**
- `id`: uuid (PK)
- `user_id`: uuid (NOT NULL) - FK to auth.users
- `type`: text (NOT NULL)
- `title`: text (NOT NULL)
- `message`: text (NOT NULL)
- `data`: jsonb (default: '{}')
- `read`: boolean (default: false)
- `created_at`: timestamptz (default: now())
- `updated_at`: timestamptz (default: now())

**Indexes:**
- PRIMARY KEY: `notifications_pkey` (id)
- B-tree: `idx_notifications_user_id` (user_id)
- Composite: `idx_notifications_read` (user_id, read)
- B-tree: `idx_notifications_created_at` (created_at DESC)

---

#### support_tickets (0 rows, 4 RLS policies)
**Purpose:** Help desk ticketing system
**Columns:**
- `id`: uuid (PK)
- `user_id`: uuid (NOT NULL) - FK to auth.users
- `subject`: text (NOT NULL)
- `category`: text (NOT NULL) - CHECK: 'technical' | 'billing' | 'therapy' | 'safety' | 'other'
- `description`: text (NOT NULL)
- `status`: text (default: 'open') - CHECK: 'open' | 'in_progress' | 'resolved' | 'closed'
- `priority`: text (default: 'medium') - CHECK: 'low' | 'medium' | 'high' | 'urgent'
- `assigned_to`: uuid (nullable) - FK to auth.users
- `resolved_at`: timestamptz (nullable)
- `created_at`: timestamptz (default: now())
- `updated_at`: timestamptz (default: now())

**Indexes:**
- PRIMARY KEY: `support_tickets_pkey` (id)
- B-tree: `idx_support_tickets_user_id` (user_id)
- B-tree: `idx_support_tickets_status` (status)
- B-tree: `idx_support_tickets_priority` (priority)

---

### 7. COMPLIANCE & MODERATION

#### audit_trail (184 rows, 3 RLS policies) ‚ö†Ô∏è GDPR CRITICAL
**Purpose:** Complete action logging for compliance
**Columns:**
- `id`: uuid (PK)
- `user_id`: uuid (nullable) - FK to auth.users (admin performing action)
- `action`: text (NOT NULL) - e.g., 'INSERT', 'UPDATE', 'DELETE', 'IMPERSONATE_START'
- `table_name`: text (NOT NULL)
- `record_id`: uuid (nullable)
- `old_data`: jsonb (nullable)
- `new_data`: jsonb (nullable)
- `ip_address`: text (nullable)
- `user_agent`: text (nullable)
- `impersonated_user_id`: uuid (nullable) - FK to auth.users (user being impersonated)
- `impersonation_reason`: text (nullable)
- `session_context`: jsonb (default: '{}')
- `created_at`: timestamptz (default: now())

**Indexes:**
- PRIMARY KEY: `audit_trail_pkey` (id)
- B-tree: `idx_audit_trail_user_id` (user_id)
- B-tree: `idx_audit_trail_created_at` (created_at DESC)
- Composite: `idx_audit_trail_user_actions` (user_id, created_at DESC)
- B-tree: `idx_audit_trail_impersonated_user` (impersonated_user_id) WHERE impersonated_user_id IS NOT NULL
- GIN: `idx_audit_trail_session_context` (session_context) WHERE session_context IS NOT NULL AND session_context <> '{}'
- Composite: `idx_audit_trail_admin_decisions` (table_name, action, created_at DESC) WHERE table_name IN ('therapist_applications', 'moderation_queue', 'support_tickets', 'therapist_profiles')

---

#### moderation_queue (0 rows, 3 RLS policies)
**Purpose:** Content moderation workflow
**Columns:**
- `id`: uuid (PK)
- `content_type`: text (NOT NULL)
- `content_id`: uuid (NOT NULL)
- `reported_by`: uuid (nullable) - FK to auth.users
- `reason`: text (NOT NULL)
- `status`: text (default: 'pending') - CHECK: 'pending' | 'reviewing' | 'resolved' | 'dismissed'
- `reviewed_by`: uuid (nullable) - FK to auth.users
- `reviewed_at`: timestamptz (nullable)
- `moderator_notes`: text (nullable)
- `created_at`: timestamptz (default: now())
- `updated_at`: timestamptz (default: now())

**Indexes:**
- PRIMARY KEY: `moderation_queue_pkey` (id)
- B-tree: `idx_moderation_queue_status` (status)
- B-tree: `idx_moderation_queue_created_at` (created_at DESC)

---

## C. Enum Types (4 Total)

### 1. app_role
**Usage:** profiles.role
**Values:** `"client" | "therapist" | "admin"`
**Default:** `'client'`

### 2. application_status
**Usage:** therapist_applications.status
**Values:** `"pending" | "under_review" | "approved" | "rejected"`
**Default:** `'pending'`

### 3. communication_style_enum
**Usage:** therapist_profiles.communication_style (stored as text, validated against enum)
**Values:**
- `"Supportive & Relational"`
- `"Motivational & Encouraging"`
- `"Pragmatic & Problem-solving"`
- `"Flexible & Adaptive"`

### 4. session_format_enum
**Usage:** therapist_profiles.session_format (stored as text, validated against enum)
**Values:**
- `"Structured & Goal-oriented"`
- `"Exploratory & Insight-based"`
- `"Interactive & Dynamic"`
- `"Calm & Process-Focused"`

---

## D. Index Summary (78 Total Indexes)

### Performance-Critical GIN Indexes (5)
‚ö†Ô∏è **These indexes are CRITICAL for matching algorithm performance:**

1. **idx_therapist_profiles_specialties_gin** (therapist_profiles.specialties)
2. **idx_therapist_profiles_modalities_gin** (therapist_profiles.modalities)
3. **idx_therapist_profiles_personality_tags_gin** (therapist_profiles.personality_tags)
4. **idx_therapist_profiles_identity_tags_gin** (therapist_profiles.identity_tags)
5. **idx_client_assessments_specialties_gin** (client_assessments.therapy_modalities)

**Additional GIN Indexes:**
- `idx_therapist_profiles_languages` (therapist_profiles.languages)
- `idx_therapist_profiles_onboarding_state_gin` (therapist_profiles.onboarding_state)
- `idx_audit_trail_session_context` (audit_trail.session_context)

### RLS Performance Indexes (10)
**Purpose:** Optimize Row Level Security policy checks

1. `idx_appointments_therapist_id_rls` (appointments.therapist_id)
2. `idx_appointments_client_id_rls` (appointments.client_id)
3. `idx_client_assessments_user_id_rls` (client_assessments.user_id)
4. `idx_client_session_notes_therapist_id_rls` (client_session_notes.therapist_id)
5. `idx_client_session_notes_client_id_rls` (client_session_notes.client_id)
6. `idx_client_testimonials_therapist_id_rls` (client_testimonials.therapist_id)
7. `idx_client_testimonials_client_id_rls` (client_testimonials.client_id)
8. `idx_session_earnings_therapist_id_rls` (session_earnings.therapist_id)
9. `idx_therapist_availability_therapist_id_rls` (therapist_availability.therapist_id)
10. `idx_therapist_blocked_times_therapist_id_rls` (therapist_blocked_times.therapist_id)

### Composite Indexes (3)
**Purpose:** Multi-column query optimization

1. `idx_therapist_profiles_active_verified` (is_active, verified, accepts_new_clients)
2. `idx_appointments_therapist_date` (therapist_id, session_date)
3. `idx_appointments_date_status` (session_date, status)

---

## E. Foreign Key Relationships

### NO Foreign Keys Detected
‚ö†Ô∏è **Important Note:** The foreign key query returned empty results, which indicates either:
1. Foreign keys exist but aren't visible in `information_schema.table_constraints` view
2. Foreign keys are documented in Supabase but not enforced at PostgreSQL level
3. The application handles referential integrity at the application layer

**Known Relationships from Type Generation:**
- `therapist_profiles.user_id` ‚Üí `auth.users.id`
- `therapist_profiles.application_id` ‚Üí `therapist_applications.id`
- `therapist_applications.user_id` ‚Üí `auth.users.id`
- `appointments.therapist_id` ‚Üí `therapist_profiles.user_id`
- `appointments.client_id` ‚Üí `auth.users.id`
- Multiple other relationships documented in database.types.ts

---

## F. RLS Policy Summary

**Total Policies:** 50 policies across 21 tables
**RLS Status:** ‚úÖ Enabled on all 21 tables

### Policy Distribution:
- **4 policies:** profiles, therapist_profiles, therapist_applications, appointments, support_tickets
- **3 policies:** audit_trail, client_assessments, client_testimonials, favorites, moderation_queue, notifications
- **2 policies:** client_session_notes, session_earnings, therapist_analytics, therapist_availability, therapist_blocked_times, identity_tags
- **1 policy:** languages, modalities, professional_bodies, specialities

---

## G. Critical Type Patterns for Other Agents

### For Matching Algorithm Agent

**Array Types Used in Matching:**
```typescript
// Therapist arrays (all text[])
specialties: string[]          // 24 options - GIN indexed
modalities: string[]           // 10 options - GIN indexed
personality_tags: string[]     // Auto-generated - GIN indexed
identity_tags: string[]        // 4 options - GIN indexed
languages: string[]            // 50+ options
cultural_background: string[]

// Client arrays (all text[])
therapy_modalities: string[]   // GIN indexed - matches therapist modalities
communication_preferences: string[]
language_preferences: string[]
identity_preferences: string[]
therapy_goals: string[]
preferred_times: string[]
budget_range: number[]         // [min, max]
```

**Enum-like Text Fields:**
```typescript
// Therapist
communication_style: string | null  // 4 values from communication_style_enum
session_format: string | null       // 4 values from session_format_enum
years_experience: string | null     // 4 values with CHECK constraint

// Client matching preferences
experience_preference: string | null  // 'No preference' | 'More than 2 years' | 'More than 5 years' | 'More than 10 years'
```

**Boolean Matching Flags:**
```typescript
// Client preferences
prefers_similar_age: boolean | null
prefers_same_gender: boolean | null
prefers_cultural_background_match: boolean | null

// Therapist attributes for matching
age_group: string | null           // For similar-age matching
gender_identity: string | null     // For same-gender matching
```

---

### For UI Agent

**Form-Facing Enum Types:**
```typescript
// Direct enums
type AppRole = 'client' | 'therapist' | 'admin'
type ApplicationStatus = 'pending' | 'under_review' | 'approved' | 'rejected'

// Communication style options
type CommunicationStyle =
  | 'Supportive & Relational'
  | 'Motivational & Encouraging'
  | 'Pragmatic & Problem-solving'
  | 'Flexible & Adaptive'

// Session format options
type SessionFormat =
  | 'Structured & Goal-oriented'
  | 'Exploratory & Insight-based'
  | 'Interactive & Dynamic'
  | 'Calm & Process-Focused'

// Years experience options (text with CHECK)
type YearsExperience =
  | 'Less than 2 years'
  | 'More than 2 years'
  | 'More than 5 years'
  | 'More than 10 years'
```

**Multi-Select Array Types:**
```typescript
// All reference table arrays should use controlled vocabularies
specialties: string[]        // From specialities table (24 options)
modalities: string[]         // From modalities table (10 options)
identity_tags: string[]      // From identity_tags table (4 options)
languages: string[]          // From languages table (50+ options)
```

**Complex JSON Field Structures:**
```typescript
// therapist_profiles.session_rates
type SessionRates = {
  [key: string]: number | Json | undefined
}

// therapist_profiles.onboarding_state
type OnboardingState = {
  current_step: string | null
  skipped_steps: string[]
  completed_steps: string[]
  last_step_completed_at: string | null  // ISO timestamp
  contextual_onboarding_started: boolean
  profile_completion_milestones: {
    "40_percent": string | null
    "60_percent": string | null
    "80_percent": string | null
    "100_percent": string | null
  }
  contextual_onboarding_completed: boolean
}

// therapist_profiles.availability_hours
type AvailabilityHours = {
  [dayOfWeek: string]: {
    start: string  // HH:MM format
    end: string    // HH:MM format
  }[]
}
```

---

### For Therapist Onboarding Agent

**Onboarding-Related Fields:**
```typescript
// therapist_profiles key fields
setup_completed: boolean                    // Overall completion flag
profile_strength: number | null             // 0-100 calculated value
onboarding_state: OnboardingState | null    // Detailed tracking JSON
setup_steps: Json                           // Legacy onboarding tracking

// Onboarding validation checks
insurance_confirmed: boolean | null
id_document_url: string | null
verified: boolean                           // Admin verification
is_active: boolean                          // Account active status
```

**Required vs Optional Fields for Profile Completion:**
```typescript
// Always required (NOT NULL)
name: string
license_number: string
user_id: string

// Required for matching (array defaults to '{}')
specialties: string[]      // Should have at least 1
modalities: string[]       // Should have at least 1
languages: string[]        // Should have at least 1

// Recommended for profile strength
bio: string | null
avatar_url: string | null
video_url: string | null
quote: string | null
communication_style: string | null
session_format: string | null
cancellation_policy: string | null
rescheduling_policy: string | null
```

---

### For TypeScript Reviewer

**All Array Type Definitions:**
```typescript
// Array<string> patterns
specialties: string[]
modalities: string[]
personality_tags: string[]
identity_tags: string[]
languages: string[]
cultural_background: string[]
therapy_modalities: string[]
communication_preferences: string[]
language_preferences: string[]
identity_preferences: string[]
therapy_goals: string[]
preferred_times: string[]

// Array<number> patterns
budget_range: number[]  // Always [min, max] pair

// JSONB array fields (stored as Json type)
documents: Json  // Actually array of document metadata
```

**Nullable Field Patterns:**
```typescript
// Profile strength and completion
profile_strength: number | null         // 0-100 or null
setup_completed: boolean                // NOT NULL, default false
verified: boolean                       // NOT NULL, default false
is_active: boolean                      // NOT NULL, default true

// Timestamps
created_at: string                      // NOT NULL, ISO timestamp
updated_at: string                      // NOT NULL, ISO timestamp
verification_date: string | null        // Nullable ISO timestamp
```

**JSON Type Safety:**
```typescript
// Generic Json type from Supabase
type Json = string | number | boolean | null | { [key: string]: Json | undefined } | Json[]

// Specific JSON fields needing type guards
session_rates: Json                     // Actually Record<string, number>
availability: Json                      // Complex availability structure
onboarding_state: Json | null          // Specific structure documented above
setup_steps: Json                       // Legacy structure
feature_flags: Json | null             // Key-value flags
documents: Json                         // Array of document metadata
session_context: Json | null           // Audit trail context
data: Json | null                      // Notification payload
```

---

## H. Database Functions (7 Total)

### 1. calculate_profile_strength
**Purpose:** Calculate therapist profile completion percentage
**Args:**
- p_avatar_url: string
- p_bio: string
- p_cancellation_policy: string
- p_communication_style: string
- p_license_number: string
- p_modalities: string[]
- p_name: string
- p_quote: string
- p_rescheduling_policy: string
- p_session_format: string
- p_specialties: string[]
- p_video_url: string

**Returns:** number (0-100)

### 2. get_current_user_role
**Purpose:** Get current authenticated user's role
**Returns:** app_role enum

### 3. is_admin
**Purpose:** Check if current user is admin
**Returns:** boolean

### 4. log_admin_decision
**Purpose:** Log admin actions to audit trail
**Args:**
- target_table: string
- target_id: string
- decision_type: string
- reason: string (optional)
- decision_data: Json (optional)

### 5. log_impersonation_end
**Purpose:** Log end of admin impersonation session
**Args:**
- target_user_id: string
- session_duration_minutes: number (optional)

**Returns:** string (audit log ID)

### 6. log_impersonation_event
**Purpose:** Log impersonation-related events
**Args:**
- target_user_id: string
- event_type: string

### 7. update_onboarding_progress
**Purpose:** Update therapist onboarding state
**Args:**
- p_user_id: string
- p_step_id: string
- p_action: string ('complete' | 'skip' | 'start')

**Returns:** Json (updated onboarding_state)

---

## I. Views (3 Total)

### 1. admin_decision_audit
**Purpose:** Filtered view of audit_trail for admin decisions
**Key Columns:**
- admin_user_id, admin_name, admin_email
- action, table_name, record_id
- decision_reason, decision_outcome
- old_data, new_data, session_context
- created_at

### 2. impersonation_audit_log
**Purpose:** Filtered view of audit_trail for impersonation events
**Key Columns:**
- admin fields (user_id, name, email)
- target_user fields (impersonated_user_id, name, email)
- impersonation_reason
- session_context, ip_address, user_agent
- created_at

### 3. migration_documentation
**Purpose:** Self-documenting migration history
**Columns:**
- name: string (migration file name)
- version: string (timestamp)
- migration_group: string (category)
- description: string (purpose)

---

## J. Type Generation Verification

### Comparison: Live Schema vs database.types.ts
‚úÖ **PERFECT MATCH** - No drift detected

**Verified Elements:**
- All 21 tables present in types
- All enum definitions match
- All nullable fields correctly typed
- All array fields typed as `string[]` or `number[]`
- All JSON fields typed as `Json`
- All relationships documented in Relationships array
- Insert/Update/Row types correctly generated
- Constants object includes all enum values

---

## K. Critical Warnings for Type Audit Teams

### ‚ö†Ô∏è WARNING 1: Array Element Type Safety
**Issue:** TypeScript types arrays as `string[]` but database has no enforcement of element values.

**Risk Areas:**
- `therapist_profiles.specialties` - Should only contain values from `specialities` table
- `therapist_profiles.modalities` - Should only contain values from `modalities` table
- `therapist_profiles.identity_tags` - Should only contain values from `identity_tags` table
- `client_assessments.therapy_modalities` - Should match modalities table

**Recommendation:** Create union types for array elements in application code.

### ‚ö†Ô∏è WARNING 2: JSON Type Safety
**Issue:** All JSON/JSONB fields typed as generic `Json` type.

**Risk Areas:**
- `therapist_profiles.onboarding_state` - Has specific structure but not enforced by types
- `therapist_profiles.session_rates` - Should be `Record<string, number>`
- `therapist_profiles.availability_hours` - Has specific day-of-week structure

**Recommendation:** Create specific TypeScript interfaces for each JSON field.

### ‚ö†Ô∏è WARNING 3: Enum-like Text Fields
**Issue:** Some fields use text with CHECK constraints instead of true enums.

**Risk Areas:**
- `therapist_profiles.communication_style` - Values exist in `communication_style_enum` but field is `text | null`
- `therapist_profiles.session_format` - Values exist in `session_format_enum` but field is `text | null`
- `therapist_profiles.years_experience` - Has CHECK constraint but typed as `text | null`

**Recommendation:** Create discriminated unions or const assertions for these fields.

### ‚ö†Ô∏è WARNING 4: Personality Tags Auto-Generation
**Issue:** `therapist_profiles.personality_tags` is auto-generated by algorithm but typed as editable array.

**Critical:** This field should NEVER be manually set by UI. It's calculated from:
- communication_style
- session_format
- bio content analysis (potential future feature)

**Recommendation:** Mark as read-only in forms and document in UI components.

### ‚ö†Ô∏è WARNING 5: Missing Foreign Key Constraints
**Issue:** Foreign key query returned empty, but relationships exist in type definitions.

**Affected Tables:** Nearly all tables have foreign key relationships documented in types but not visible in schema queries.

**Recommendation:** Verify if constraints exist at database level or only at Supabase dashboard level.

---

## L. Performance Index Impact on Types

### GIN Indexes Enable Array Overlap Queries
**Query Pattern:**
```sql
-- Find therapists with ANY matching specialty
WHERE specialties && ARRAY['Anxiety', 'Depression']

-- Find therapists with ALL specified specialties
WHERE specialties @> ARRAY['Anxiety', 'Depression']
```

**Type Impact:** Array fields with GIN indexes should be treated as queryable sets, not ordered lists.

### RLS Indexes Require User Context
**Query Pattern:**
```sql
-- RLS policies automatically inject WHERE clauses
WHERE user_id = auth.uid()
WHERE therapist_id = auth.uid()
```

**Type Impact:** All queries automatically filtered by RLS. Types don't reflect this filtering, but it happens at database level.

### Composite Indexes Suggest Query Patterns
**Recommended Queries:**
```sql
-- Use composite index: (is_active, verified, accepts_new_clients)
WHERE is_active = true AND verified = true AND accepts_new_clients = true

-- Use composite index: (therapist_id, session_date)
WHERE therapist_id = $1 AND session_date >= $2

-- Use composite index: (session_date, status)
WHERE session_date = $1 AND status = 'scheduled'
```

---

## M. Reference Data for Testing

### Specialties (24 available)
Use exact strings from Section B.5 for array elements.

### Modalities (10 available)
Use exact strings from Section B.5 for array elements.

### Identity Tags (4 available)
Use exact strings from Section B.5 for array elements.

### Professional Bodies (17 available)
Use abbreviations from Section B.5.

### Languages (50 available)
Query `languages` table for current list.

---

## N. Next Steps for Phase 2-6 Agents

### Phase 2: Matching Algorithm Agent
**Use this report to:**
- Validate array types used in matching logic
- Verify GIN index coverage for performance
- Check enum values for communication_style and session_format
- Audit personality_tags generation logic

### Phase 3: UI Agent
**Use this report to:**
- Build form validation for enum types
- Create multi-select components with correct reference data
- Implement JSON field editors with proper structure
- Add type guards for nullable fields

### Phase 4: Therapist Onboarding Agent
**Use this report to:**
- Map onboarding steps to database fields
- Validate profile_strength calculation inputs
- Track setup_completed and onboarding_state updates
- Verify required fields for each onboarding stage

### Phase 5: TypeScript Reviewer
**Use this report to:**
- Create stricter types than generic database.types.ts
- Add discriminated unions for enum-like text fields
- Create interfaces for all JSON fields
- Add array element type constraints

### Phase 6: SQL Reviewer
**Use this report to:**
- Verify all migrations maintain index coverage
- Check new columns follow nullable/NOT NULL patterns
- Ensure new array columns get GIN indexes if used in matching
- Validate RLS policies exist for new tables

---

## O. Document Version Control

**Version:** 1.0
**Generated:** 2025-09-29
**Last Schema Update:** 2025-09-29 (migrations applied: 20250929_add_rls_performance_indexes, 20250929_query_performance_optimizations)
**Next Update Required:** After any schema migration or type generation

**Verification Commands:**
```sql
-- Verify table count
SELECT COUNT(*) FROM information_schema.tables WHERE table_schema = 'public' AND table_type = 'BASE TABLE';
-- Expected: 21

-- Verify RLS enabled
SELECT COUNT(*) FROM pg_tables WHERE schemaname = 'public' AND rowsecurity = true;
-- Expected: 21

-- Verify index count
SELECT COUNT(*) FROM pg_indexes WHERE schemaname = 'public';
-- Expected: 78

-- Verify policy count
SELECT COUNT(*) FROM pg_policies WHERE schemaname = 'public';
-- Expected: 50
```

---

## P. Glossary for Non-Technical Users

- **GIN Index:** Fast search for array elements (e.g., finding therapists with specific specialties)
- **RLS (Row Level Security):** Automatic filtering so users only see their own data
- **JSONB:** Flexible data format for complex structures (like availability schedules)
- **NOT NULL:** Field must have a value, can't be empty
- **Nullable:** Field can be empty (null)
- **Enum:** Fixed set of allowed values (like a dropdown menu)
- **Foreign Key:** Link between tables (e.g., appointments link to therapists)
- **Index:** Database performance optimization (makes queries faster)
- **Composite Index:** Index on multiple columns together

---

**END OF PHASE 1 BASELINE REPORT**

This document serves as the single source of truth for database schema structure during the type audit process. All other agents should reference this document rather than querying the database directly.
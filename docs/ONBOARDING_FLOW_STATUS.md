# Onboarding Flow Implementation Status

## ‚úÖ Completed

### 1. Quick Start localStorage Persistence
**File**: `src/pages/therapist/QuickStart.tsx`

**Changes Made:**
- Added `useEffect` to load Quick Start progress from localStorage on mount
- Added `useEffect` to save formData to localStorage on every change
- Updated `handleSubmit` to navigate to `/t/signup` instead of saving to database
- Changed final button text from "Enter Your Workspace" to "Create Your Account"
- Quick Start is now fully anonymous - no authentication required

**localStorage Data Structure:**
```json
{
  "formData": {
    "firstName": "...",
    "lastName": "...",
    "email": "...",
    "title": "...",
    "registrationBody": "...",
    "licenseNumber": "...",
    "yearsExperience": "...",
    "communicationStyle": "Supportive and Relational",
    "sessionFormat": "Flexible and Adaptive",
    "specialties": ["Trauma", "Anxiety"],
    "modalities": ["CBT", "EMDR"]
  },
  "currentStep": 5,
  "currentSubStep": "communication",
  "savedAt": "2025-10-02T..."
}
```

## üîÑ In Progress

### 2. Update Signup Page
**File**: `src/pages/therapist/SignUp.tsx`

**Changes Needed:**
1. Pre-fill firstName, lastName, email from localStorage on mount
2. After successful signup:
   - Create auth user (already done)
   - Create therapist_profiles record with all Quick Start data
   - Clear localStorage
   - Redirect to `/t/dashboard` instead of `/t/quick-start`

**Specific Code Changes:**

**A. Pre-fill form data from localStorage:**
```typescript
// After line 39, add:
useEffect(() => {
  const quickStartData = localStorage.getItem('quickStartProgress');
  if (quickStartData) {
    try {
      const parsed = JSON.parse(quickStartData);
      const data = parsed.formData || parsed;

      setFormData(prev => ({
        ...prev,
        firstName: data.firstName || '',
        lastName: data.lastName || '',
        email: data.email || ''
      }));
    } catch (error) {
      console.error('Error loading Quick Start data:', error);
    }
  }
}, []);
```

**B. Create therapist profile after signup (replace lines 74-98):**
```typescript
const { data: authData, error: authError } = await supabase.auth.signUp({
  email: formData.email,
  password: formData.password,
  options: {
    emailRedirectTo: `${window.location.origin}/t/dashboard`,  // Changed from /t/quick-start
    data: {
      first_name: formData.firstName,
      last_name: formData.lastName,
      role: 'therapist',
      roles: ['therapist'],
      user_type: 'therapist',
      notify_email: !!formData.notifyEmail,
      notify_sms: !!formData.notifySMS,
      mfa_enroll_on_first_login: !!formData.enable2FA,
    },
  },
});

if (authError) {
  setError(authError.message);
  return;
}

// Get Quick Start data from localStorage
const quickStartData = JSON.parse(localStorage.getItem('quickStartProgress') || '{}');
const qsData = quickStartData.formData || quickStartData;

// Create therapist profile with Quick Start data
const { error: profileError } = await supabase
  .from('therapist_profiles')
  .insert({
    id: authData.user.id,
    user_id: authData.user.id,
    first_name: formData.firstName,
    last_name: formData.lastName,
    email: formData.email,
    title: qsData.title || qsData.customTitle,
    registration_body: qsData.registrationBody || qsData.customRegistrationBody,
    license_number: qsData.licenseNumber,
    years_experience: qsData.yearsExperience,
    communication_style: toDbFormat(qsData.communicationStyle),  // Convert to database format
    session_format: toDbFormat(qsData.sessionFormat),  // Convert to database format
    specialties: qsData.specialties || [],
    modalities: qsData.modalities || [],
    setup_completed: true,
    // personality_tags will be auto-generated by database trigger
  });

if (profileError) {
  console.error('Error creating therapist profile:', profileError);
  setError('Account created but profile setup failed. Please contact support.');
  return;
}

// Clear localStorage
localStorage.removeItem('quickStartProgress');
localStorage.removeItem('quickStartComplete');

// Navigate to dashboard
navigate('/t/dashboard');
```

**C. Update success screen redirect (line 120):**
```typescript
// Change from:
<Button onClick={() => navigate("/t/quick-start")} className="mt-6">
  Start Quick Setup
</Button>

// To:
<Button onClick={() => navigate("/t/dashboard")} className="mt-6">
  Go to Dashboard
</Button>
```

**D. Update success message (line 115-119):**
```typescript
// Change from:
<h1 className="text-3xl font-bold mt-4">Confirm your email</h1>
<p className="text-muted-foreground mt-2">
  We've sent a confirmation link to <strong>{formData.email}</strong>.
  Please check your inbox (and spam folder!) to continue.
</p>

// To:
<h1 className="text-3xl font-bold mt-4">Welcome to Mindfolk!</h1>
<p className="text-muted-foreground mt-2">
  Your account has been created! We've sent a verification link to <strong>{formData.email}</strong>.
  You can start building your profile now - email verification can be completed anytime before publishing.
</p>
```

**E. Add import for toDbFormat (line 14):**
```typescript
import { toDbFormat } from '@/lib/formatMapping';
```

## ‚è≥ Pending

### 3. Update Routing
**File**: `src/App.tsx`

**Changes Needed:**
- Ensure `/t/quick-start` route doesn't require authentication
- Verify `/t/signup` route is accessible without auth

### 4. Dashboard Contextual Onboarding
**File**: `src/pages/therapist/Dashboard.tsx`

**Changes Needed:**
- Add email verification as a setup task (non-blocking)
- Show banner if email not verified
- Allow dashboard exploration without verified email

### 5. Profile Publishing Gate
**File**: Wherever profile "Publish" button lives

**Changes Needed:**
- Require email verification before publishing profile
- Show clear message: "Verify your email to publish profile and receive client matches"

## Benefits of New Flow

1. **Zero friction start** - No sign-up wall blocks therapists from exploring
2. **Value demonstration** - Complete 6-screen Quick Start before commitment
3. **Investment bias** - More likely to sign up after spending 5+ minutes
4. **No email blocker** - Can access dashboard immediately after signup
5. **Logical gates** - Email verification only required for profile publishing
6. **Data persistence** - localStorage ensures no data loss if browser closed

## Next Steps

1. Complete SignUp.tsx changes (outlined above)
2. Update App.tsx routing if needed
3. Test full flow:
   - Homepage ‚Üí Quick Start (anonymous)
   - Complete all 6 screens
   - Sign up ‚Üí Creates profile with Quick Start data
   - Redirect to dashboard
   - Verify email shown as setup task
   - Cannot publish profile without verification
4. Clean up any residual auth checks in Quick Start flow
5. Update any documentation/comments referencing old flow

## Migration Notes

**No database changes required** - Using existing schema:
- `therapist_profiles` table already has all fields
- `generate_personality_tags()` trigger still works
- Email verification through existing Supabase auth

**Backwards compatibility:**
- Existing therapists unaffected
- Old Quick Start flow (with auth) still works if accessed directly
- New flow is opt-in via localStorage detection
